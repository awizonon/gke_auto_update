name: DEPLOY
on:
    push:
        branches: [main]

env:
  PROJECT_ID: poc-terraform-359717
  GKE_CLUSTER: prod-cluster-1    # Add your cluster name here.
  GKE_ZONE: europe-west1   # Add your cluster zone here.
  DEPLOYMENT_NAME: gke-test # Add your deployment name here.
  IMAGE: static-site

jobs:
    job1:
        runs-on: [self-hosted, gke]
        steps:
            - run: echo "test ok"

            - name: Checkout
              uses: actions/checkout@v3

            - name: Set gcloud CLI
              run: gcloud auth activate-service-account --key-file=/home/camegan/key.json

            - name: test
              run: gcloud auth list

	    - name: Build and push script
              run: cd /home/camegan/actions-runner/_work/gke_auto_update/gke_auto_update/.github/workflows && chmod +x script && bash script 
            - name: Set get cluster
              run: gcloud container clusters get-credentials $GKE_CLUSTER --region $GKE_ZONE --project $PROJECT_ID

            - name: Deploy test pod
              run: cd /home/camegan/deploy && kubectl apply -f test.yaml && kubectl apply -f service.yaml
